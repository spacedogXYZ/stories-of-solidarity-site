"use strict";window.Solidarity=_.extend(window.Solidarity,{Models:{},Collections:{},Views:{},Routers:{},init:function(){console.log("Stories of Solidarity"),new Solidarity.Routers.Auth({}),new Solidarity.Routers.Pages({}),new Solidarity.Routers.Stories({}),Backbone.history.start()}}),window.urlParam=function(a){var b=window.location.href.match(/^[^#]+#([^?]*)\??(.*)/),c=(b[1],b[2]),d=c.split(a+"=")[1];return void 0!==d?decodeURIComponent(d.split("&")[0]):null},$(document).ready(function(){Solidarity.init()}),this.JST=this.JST||{},this.JST["app/scripts/templates/about.ejs"]=function(){{var a="";_.escape}return a+='<h1>About</h1>\n\n<section class="jumbotron">\n    <h2>Stories of Solidarity</h2>\n    <p>A social media platform that encourages workers in the low-wage, precarious workforce to build new forms of solidarity.</p>\n</section>\n\n<section>\n    <iframe src="//player.vimeo.com/video/75254033?title=0&amp;byline=0" width="800" height="450" frameborder="0" webkitallowfullscreen="" mozallowfullscreen="" allowfullscreen=""></iframe>\n</section>'},this.JST["app/scripts/templates/authError.ejs"]=function(a){{var b,c="";_.escape}return c+='<div class="alert alert-danger" role="alert">\n  <span class="glyphicon glyphicon-exclamation-sign" aria-hidden="true"></span>\n  <span class="sr-only">Error:</span>\n  '+(null==(b=a.non_field_errors)?"":b)+"\n</div>"},this.JST["app/scripts/templates/authLogin.ejs"]=function(){{var a,b="";_.escape}return b+='<div class="authLogin container-fluid">\n<h2>Log In</h2>\n\n<form class="form-horizontal" id="login" action="'+(null==(a=Solidarity.apiRoot)?"":a)+'auth/login/" method="POST">\n    <div class="form-group">\n        <label for="username" class="col-sm-2 control-label">Username:</label>\n        <input name="username" class="col-sm-4" />\n        <span class="help-block"></span>\n    </div>\n\n    <div class="form-group">\n        <label for="password" class="col-sm-2 control-label">Password:</label>\n        <input name="password" class="col-sm-4" type="password"/>\n        <span class="help-block"></span>\n    </div>\n\n    <div class="form-group">\n        <button class="btn btn-primary col-sm-offset-2" type="submit">\n            <span class="glyphicon glyphicon-log-in"></span> Go\n        </button>\n    </div>\n</form>\n\n</div>'},this.JST["app/scripts/templates/copyright.ejs"]=function(){{var a="";_.escape}return a+="<h1>Copyright Policy</h1>\n\n<p>copyright page content here</p>\n"},this.JST["app/scripts/templates/index.ejs"]=function(){{var a="";_.escape}return a+='<div id="intro"></div>\n\n<div id="map"></div>\n'},this.JST["app/scripts/templates/intro.ejs"]=function(){{var a="";_.escape}return a+='<div class="modal fade" id="introModal">\n    <div class="modal-dialog">\n        <div class="modal-content">\n            <div class="modal-header">\n                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>\n                <h4 class="modal-title">Work in Progress</h4>\n            </div>\n            <div class="modal-body">\n                <p>Stories of Solidarity is a work in progress.</p>\n                <p>Please feel free to browse and leave us feedback at: </p>\n                <p><a href="mailto:storiesofsolidarity@gmail.com">storiesofsolidarity@gmail.com</a></p>\n                <p>Thank you!</p>\n            </div>\n            <div class="modal-footer">\n                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>\n            </div>\n        </div>\n    </div>\n</div>'},this.JST["app/scripts/templates/privacy.ejs"]=function(){{var a="";_.escape}return a+="<h1>Privacy Policy</h1>\n\n<p>privacy page content here</p>\n"},this.JST["app/scripts/templates/story.ejs"]=function(a){{var b,c="",d=_.escape;Array.prototype.join}return c+='<div class="storyRead">\n    <h1>',a.title&&(c+="\n            "+(null==(b=a.title)?"":b)+"<br> by\n        "),c+="\n        ",c+=a.author&&a.author.anonymous!==!0?'\n            <a href="#read/author/'+d(a.author.user.id)+'">'+d(a.author.user.first_name)+" "+d(a.author.user.last_name)+"</a>\n        ":"\n            Anonymous\n        ",c+="\n        ",a.location&&a.location.city&&a.location.state&&(c+="\n            from "+(null==(b=a.location.city)?"":b)+", "+(null==(b=a.location.state)?"":b)+"\n        "),c+="\n    </h1>\n    <h2>"+(null==(b=new Date(a.updated_at).toDateString())?"":b)+'</h2>\n\n    <div class="body">\n        '+d(a.content)+'\n    </div>\n    \n    <a href="#back" onclick="history.go(-1);return false;" >&larr; Back</a>\n</div>'},this.JST["app/scripts/templates/storyList.ejs"]=function(){{var a="";_.escape}return a+='<div class="storyList">\n    <!-- story items added here -->\n    \n    <div class="item more" style="display:none;">\n        <h2><a class="loadMore" href="#read">+ More</a></h2>\n    </div>\n</div>\n'},this.JST["app/scripts/templates/storyListItem.ejs"]=function(a){{var b,c="",d=_.escape;Array.prototype.join}return c+='<div class="item story" id="story-'+(null==(b=a.id)?"":b)+'">\n    <h2>'+(null==(b=a.title)?"":b)+'</h2>\n    <div class="body">\n        ',c+=a.content.length>160?"\n            "+d(a.content.slice(0,160))+"...\n        ":"\n            "+d(a.content)+"\n        ",c+='\n        <span class="readMore">\n            <a class="readMore" href="#read/story/'+(null==(b=a.id)?"":b)+'">+ read more</a>\n        </span>\n    </div>\n    <h3>'+(null==(b=new Date(a.updated_at).toDateString())?"":b)+"<br>\n        by ",c+=a.author.user?'\n            <a href="#read/author/'+d(a.author.user.id)+'">'+d(a.author.user.first_name)+" "+d(a.author.user.last_name)+"</a>\n        ":"\n            Anonymous\n        ",c+="\n        </h3>\n</div>"},this.JST["app/scripts/templates/storyMap.ejs"]=function(){{var a="";_.escape}return a+='<div id="map" class="storyMap"></div>'},this.JST["app/scripts/templates/storyPost.ejs"]=function(){{var a,b="";_.escape,Array.prototype.join}return b+='<div class="storyPost container-fluid">\n<h2>Share Your Story</h2>\n<div class="row">\n    <div class="col-md-4">\n        Post \n        ',b+=void 0!==Solidarity.user?'\n        as <a href="#auth/user">'+(null==(a=Soldarity.user)?"":a)+'</a>\n        or <a href="#auth/logout">Logout</a>\n        ':'\n        anonymously or <a href="#auth/login?success=share" >Login</a>\n        ',b+='\n    </div>\n</div>\n\n<form action="'+(null==(a=Solidarity.apiRoot)?"":a)+'story" method="POST" class="form-horizontal">\n    <fieldset>\n        <div class="form-group">\n            <label for="title" class="col-md-1">Title:</label>\n            <input id="title" class="col-xs-12 col-md-6" name="title" value="" type="text" autocomplete="on" placeholder="">\n        </div>\n\n        <div class="form-group">\n            <label for="content" class="col-md-1">Story:</label>\n            <textarea id="content" class="col-xs-12 col-md-10" rows="6" name="content" value="" required="required"></textarea>\n        </div>\n\n        <div class="form-group">\n            <label for="location" class="col-md-1">Location:</label>\n            <div class="input-group col-xs-12 col-md-6">\n                <input id="location" class="col-xs-12" name="location" value="" type="text" autocomplete="on" placeholder="">\n                <div class="input-group-btn">\n                    <button type="button" class="btn btn-sm line-height-1"><i class="glyphicon glyphicon-screenshot"></i></button>\n                </div>\n            </div>\n        </div>\n\n        <div class="form-group">\n            <label for="photo" class="col-md-1">Photo:</label>\n            <input type="file" class="col-md-6 filestyle" name="photo" />\n        </div>\n\n        <div class="form-group">\n            <input type="submit" class="btn btn-primary" value="Post!" />\n        </div>\n    </fieldset>\n</form>\n\n</div>'},Solidarity.Models=Solidarity.Models||{},function(){Solidarity.Models.BaseModel=Backbone.Model.extend({initialize:function(){},defaults:{},validate:function(){},parse:function(a){return a},url:function(){var a=this.get("links"),b=a&&a.self;return b||(b=Backbone.Model.prototype.url.call(this)),b}})}(),Solidarity.Models=Solidarity.Models||{},function(){Solidarity.Models.Story=Solidarity.Models.BaseModel.extend({urlRoot:Solidarity.apiRoot+"story"})}(),Solidarity.Models=Solidarity.Models||{},function(){Solidarity.Models.Author=Solidarity.Models.BaseModel.extend({url:Solidarity.apiRoot+"author",idAttributemodel:"username"})}(),Solidarity.Models=Solidarity.Models||{},function(){Solidarity.Models.Location=Solidarity.Models.BaseModel.extend({urlRoot:Solidarity.apiRoot+"location"})}(),Solidarity.Collections=Solidarity.Collections||{},function(){Solidarity.Collections.BaseCollection=Backbone.PageableCollection.extend({resultsField:"results",totalRecordsField:"count",nextField:"next",previousField:"previous",queryParams:{totalPages:null,totalRecords:null,pageSize:null},state:{pageSize:25},parseRecords:function(a){return a&&_.has(a,this.resultsField)&&_.isArray(a[this.resultsField])?a[this.resultsField]:void Backbone.PageableCollection.prototype.parseRecords.apply(this,arguments)},parseState:function(a){return{totalRecords:a[this.totalRecordsField]}},parseLinks:function(a){return{prev:a[this.previousField],next:a[this.nextField],first:null}}})}(),Solidarity.Collections=Solidarity.Collections||{},function(){Solidarity.Collections.Stories=Solidarity.Collections.BaseCollection.extend({model:Solidarity.Models.Story,url:Solidarity.apiRoot+"story"})}(),Solidarity.Collections=Solidarity.Collections||{},function(){Solidarity.Collections.Authors=Solidarity.Collections.BaseCollection.extend({model:Solidarity.Models.Author})}(),Solidarity.Collections=Solidarity.Collections||{},function(){Solidarity.Collections.Locations=Solidarity.Collections.BaseCollection.extend({model:Solidarity.Models.Location,url:Solidarity.apiRoot+"location"})}(),Solidarity.Views=Solidarity.Views||{},function(){Solidarity.Views.BaseView=Backbone.View.extend({assign:function(a,b){a.setElement(this.$(b)).render()},initialize:function(){this.render()},render:function(){return this.$el.html(this.template()),this}}),Solidarity.Views.FormView=Solidarity.Views.BaseView.extend({events:{submit:"submit","keyup input.has-error":"clearFieldErrors"},render:function(){return this.$el.html(this.template()),this.$form=$(this.form),this},clearFieldErrors:function(a){var b=this,c=$(a.target).attr("name");$(b.form+' label[for="'+c+'"]').removeClass("has-error"),$(b.form+' input[name="'+c+'"]').removeClass("has-error"),$(b.form+' input[name="'+c+'"] + .help-block').html("")},submit:function(a){var b=this;a.preventDefault(),$.ajax({type:b.$form.attr("method"),url:b.$form.attr("action"),data:b.$form.serializeArray(),success:function(){return $(b.form+" .alert").remove(),void 0!==b.successCallback?b.successCallback():window.urlParam("success")?(Backbone.history.navigate(window.urlParam("success"),{trigger:!0}),!0):void 0},error:function(a){$(b.form+" .alert").remove(),b.$form.addClass("error");var c=a.responseJSON;_.map(c,function(a,c){$(b.form+' label[for="'+c+'"]').addClass("has-error"),$(b.form+' input[name="'+c+'"]').addClass("has-error"),$(b.form+' input[name="'+c+'"] + .help-block').html(a)}),void 0!==c.non_field_errors&&b.$form.append(b.templateError(c))}})}})}(),Solidarity.Views=Solidarity.Views||{},function(){Solidarity.Views.Story=Solidarity.Views.BaseView.extend({template:JST["app/scripts/templates/story.ejs"],el:"#content",events:{},initialize:function(){var a=this;this.listenTo(this.model,"add",this.render),this.model.fetch({success:$.proxy(a.render,a)})},render:function(){this.model&&this.model.attributes&&this.$el.html(this.template(this.model.toJSON()))}})}(),Solidarity.Views=Solidarity.Views||{},function(){Solidarity.Views.StoryList=Solidarity.Views.BaseView.extend({template:JST["app/scripts/templates/storyList.ejs"],templateItem:JST["app/scripts/templates/storyListItem.ejs"],el:"#content",events:{"click a.loadMore":"loadMore"},initialize:function(){var a=this;this.render(),this.collection=new Solidarity.Collections.Stories({mode:"infinite"}),this.listenTo(this.collection,"add",this.addStory),this.collection.getFirstPage({success:function(){$(".item.more").show(),window.location.href.indexOf("?story=")>0&&a.scrollTo(Solidarity.urlParam("story"))}})},addStory:function(a){$(this.templateItem(a.attributes)).insertBefore(".storyList .item.more"),this.collection.hasNextPage()||$(".item.more").hide()},render:function(){this.$el.html(this.template())},loadMore:function(){this.collection.getNextPage()},scrollTo:function(a){var b=$("#story-"+a);b.length>0&&$("html, body").scrollTop(b.offset().top)}})}(),Solidarity.Views=Solidarity.Views||{},function(){Solidarity.Views.StoryMap=Solidarity.Views.BaseView.extend({template:JST["app/scripts/templates/storyMap.ejs"],events:{},initialize:function(){var a=this;this.render(),this.collection=new Solidarity.Collections.Locations({}),this.collection.fetch({success:function(){a.renderStories(),a.listenTo(a.collection,"add change",a.renderStories)}})},drawMap:function(){function a(a){if(g.node()===this)return b();g.classed("active",!1),g=d3.select(this).classed("active",!0);var c=.9;"25"===a.id&&(c=.75),"36"===a.id&&(c=.6),"09"===a.id&&(c=.5),"44"===a.id&&(c=.3),"11"===a.id&&(c=.2);var d=i.bounds(a),k=d[1][0]-d[0][0],l=d[1][1]-d[0][1],m=(d[0][0]+d[1][0])/2,n=(d[0][1]+d[1][1])/2,o=c/Math.max(k/e,l/f),p=[e/2-o*m,f/2-o*n];j.svg.transition().duration(750).call(h.translate(p).scale(o).event)}function b(){g.classed("active",!1),g=d3.select(null),j.svg.transition().duration(750).call(h.translate([0,0]).scale(1).event)}function c(){j.map.style("stroke-width",1.5/d3.event.scale+"px"),j.map.attr("transform","translate("+d3.event.translate+")scale("+d3.event.scale+")")}function d(){d3.event.defaultPrevented&&d3.event.stopPropagation()}var e=960,f=500,g=d3.select(null);this.projection=d3.geo.albersUsaPr().scale(1e3).translate([e/2,f/2]);var h=d3.behavior.zoom().translate([0,0]).scale(1).scaleExtent([1,8]).on("zoom",c),i=d3.geo.path().projection(this.projection);this.svg=d3.select("#map").append("svg").attr("width",e).attr("height",f).on("click",d,!0),this.svg.append("rect").attr("class","background").attr("width",e).attr("height",f).on("click",b),this.map=this.svg.append("g");var j=this;this.svg.call(h.event),d3.json(Solidarity.siteRoot+"scripts/map/us.json",function(b,c){j.map.selectAll("path").data(topojson.feature(c,c.objects.states).features).enter().append("path").attr("d",i).attr("class","feature").on("click",a),j.map.append("path").datum(topojson.mesh(c,c.objects.states,function(a,b){return a!==b})).attr("class","mesh").attr("d",i)})},render:function(){this.$el.html(this.template()),this.drawMap()},renderStories:function(){console.log("storyMap.renderStories");var a=this.projection,b=d3.scale.log();b.domain([1,100]).range([.5,0]);var c=d3.tip().html(function(a){var b='<%= story_count %> stor<%= story_count > 1 ? "ies" : "y"%> in <%= city %>, <%= state %>';return _.template(b)(a.attributes)});this.map.call(c),this.map.append("g").attr("class","bubble").selectAll("circle").data(this.collection.models).enter().append("circle").attr("r",function(){return 5}).attr("transform",function(b){var c=a([b.attributes.lon,b.attributes.lat]);return"translate("+c+")"}).style("opacity",function(a){return b(a.attributes.story_count)}).on("mouseover",c.show).on("mouseout",c.hide)}})}(),Solidarity.Views=Solidarity.Views||{},function(){Solidarity.Views.StoryPost=Solidarity.Views.BaseView.extend({template:JST["app/scripts/templates/storyPost.ejs"],el:"#content",render:function(){return this.$el.html(this.template()),$(".filestyle").filestyle({input:!1,buttonText:"Upload",size:"sm",iconName:"glyphicon-cloud-upload"}),this}})}(),Solidarity.Views=Solidarity.Views||{},function(){Solidarity.Views.AuthLogin=Solidarity.Views.FormView.extend({form:"form#login",template:JST["app/scripts/templates/authLogin.ejs"],templateError:JST["app/scripts/templates/authError.ejs"]}),Solidarity.Views.AuthRegister=Solidarity.Views.FormView.extend({form:"form#register",template:JST["app/scripts/templates/authRegister.ejs"],templateError:JST["app/scripts/templates/authError.ejs"]})}(),Solidarity.Views=Solidarity.Views||{},function(){Solidarity.Views.Page=Solidarity.Views.BaseView.extend({el:"#content",initialize:function(a){this.template=JST[a],this.render()},render:function(){return this.$el.html(this.template()),this}})}(),Solidarity.Views=Solidarity.Views||{},function(){Solidarity.Views.Intro=Solidarity.Views.BaseView.extend({template:JST["app/scripts/templates/intro.ejs"],events:{},initialize:function(){this.render(),$("#introModal").modal("true"===$.cookie("hideModal")?"hide":"show"),$("#introModal").on("hidden.bs.modal",function(){$.cookie("hideModal","true")})}})}(),Solidarity.Views=Solidarity.Views||{},function(){Solidarity.Views.Index=Solidarity.Views.BaseView.extend({template:JST["app/scripts/templates/index.ejs"],el:"#content",events:{},initialize:function(){this.render(),this.introView=new Solidarity.Views.Intro({el:"#intro"})},render:function(){this.$el.html(this.template())}})}(),Solidarity.Routers=Solidarity.Routers||{},function(){Solidarity.Routers.Auth=Backbone.Router.extend({routes:{"auth/register":"register","auth/login":"login","auth/logout":"logout","auth/password/change":"passwordChange","auth/password/reset":"passwordReset","auth/password/reset/confirm":"passwordResetConfirm"},register:function(){new Solidarity.Views.AuthRegister({el:"#content"})},login:function(){new Solidarity.Views.AuthLogin({el:"#content"})},logout:function(){new Solidarity.Views.AuthLogout({el:"#content"})},passwordChange:function(){new Solidarity.Views.AuthPasswordChange({el:"#content"})},passwordReset:function(){new Solidarity.Views.AuthPasswordReset({el:"#content"})},passwordResetConfirm:function(){new Solidarity.Views.AuthPasswordResetConfirm({el:"#content"})}})}(),Solidarity.Routers=Solidarity.Routers||{},function(){Solidarity.Routers.Pages=Backbone.Router.extend({routes:{"":"index",about:"about",privacy:"privacy",copyright:"copyright"},index:function(){new Solidarity.Views.Index({})},about:function(){new Solidarity.Views.Page("app/scripts/templates/about.ejs")},privacy:function(){new Solidarity.Views.Page("app/scripts/templates/privacy.ejs")},copyright:function(){new Solidarity.Views.Page("app/scripts/templates/copyright.ejs")}})}(),Solidarity.Routers=Solidarity.Routers||{},function(){Solidarity.Routers.Stories=Backbone.Router.extend({routes:{map:"storyMap",read:"storyList","read/story/:id":"storyView",share:"storyPost"},storyMap:function(){new Solidarity.Views.StoryMap({el:"#content"})},storyList:function(){new Solidarity.Views.StoryList({el:"#content"})},storyView:function(a){new Solidarity.Views.Story({model:new Solidarity.Models.Story({id:a})})},storyPost:function(){new Solidarity.Views.StoryPost({el:"#content"})}})}();